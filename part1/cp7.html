<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>第七章 新属性和属性相关特性 - C++ 17 The Complete Guide</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../part1/index.html">第一部分 基本语言特性</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../part1/cp1.html">第一章 结构化绑定</a></li><li class="chapter-item "><a href="../part1/cp2.html">第二章 带初始化的if和switch</a></li><li class="chapter-item "><a href="../part1/cp3.html">第三章 内联变量</a></li><li class="chapter-item "><a href="../part1/cp4.html">第四章 聚合扩展</a></li><li class="chapter-item "><a href="../part1/cp5.html">第五章 强制拷贝消除或者传递未具体化对象</a></li><li class="chapter-item "><a href="../part1/cp6.html">第六章 Lambda扩展</a></li><li class="chapter-item expanded "><a href="../part1/cp7.html" class="active">第七章 新属性和属性相关特性</a></li><li class="chapter-item "><a href="../part1/cp8.html">第八章 其他语言特性</a></li></ol></li><li class="chapter-item expanded "><a href="../part2/index.html">第二部分 模板特性</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../part2/cp9.html">第九章 类模板参数推导</a></li><li class="chapter-item "><a href="../part2/cp10.html">第十章 编译期if</a></li><li class="chapter-item "><a href="../part2/cp11.html">第十一章 折叠表达式</a></li><li class="chapter-item "><a href="../part2/cp12.html">第十二章 String作为模板参数</a></li><li class="chapter-item "><a href="../part2/cp13.html">第十三章 auto作为模板参数占位符</a></li><li class="chapter-item "><a href="../part2/cp14.html">第十四章 扩展Using声明</a></li></ol></li><li class="chapter-item expanded "><div>第三部分 新的标准库组件</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../part3/cp15.html">第十五章 std::optional&lt;&gt;</a></li><li class="chapter-item "><div>第十六章 std::variant&lt;&gt;</div></li><li class="chapter-item "><div>第十七章 std::any</div></li><li class="chapter-item "><div>第十八章 std::byte</div></li><li class="chapter-item "><div>第十九章 String View</div></li><li class="chapter-item "><div>第二十章 文件系统库</div></li></ol></li><li class="chapter-item expanded "><div>第四部分 标准库扩展和修改</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>第二十一章 Type Trait扩展</div></li><li class="chapter-item "><div>第二十二章 并行STL算法</div></li><li class="chapter-item "><div>第二十三章 子字符串和子序列搜索</div></li><li class="chapter-item "><div>第二十四章 其他工具函数和算法</div></li><li class="chapter-item "><div>第二十五章 容器扩展</div></li><li class="chapter-item "><div>第二十六章 多线程和兵法</div></li></ol></li><li class="chapter-item expanded "><div>第五部分 专业工具</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>第二十七章 多态类型资源（PMR）</div></li><li class="chapter-item "><div>第二十八章 对齐数据上的new和delete</div></li><li class="chapter-item "><div>第二十九章 其他专业库的改动</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">C++ 17 The Complete Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/CnTransGroup/Cpp17TheCompleteGuideChinese" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="第七章-新属性和属性相关特性"><a class="header" href="#第七章-新属性和属性相关特性">第七章 新属性和属性相关特性</a></h1>
<p>C++11开始，你可以指定属性（attribute，一种规范的注解，可以启用或者禁用一些warning）。C++17还引入了新的属性。此外，属性现在可以在更多的地方使用，并且有一些额外的便利。</p>
<h2 id="71-nodiscard属性"><a class="header" href="#71-nodiscard属性">7.1 <code>[[nodiscard]]</code>属性</a></h2>
<p>新属性<code>[[nodiscard]]</code>用于鼓励编译器，当发现函数返回值没有被使用的时候，产生一个warning。</p>
<p>通常，这个属性可以用于通知一些返回值没有使用的错误行为。错误行为可能是：</p>
<ul>
<li><strong>内存泄漏</strong>，比如没有使用已经分配并返回的内存</li>
<li><strong>不符合期望，或者非直观行为</strong>，比如没有使用返回值时候可能产生的一些不同寻常/不符合期望的行为</li>
<li><strong>不必要的负载</strong>，比如如果没有使用返回值，这个调用过程相当于无操作。</li>
</ul>
<p>这是一些例子，它们展示了这个属性的是有用的：</p>
<ul>
<li>分配资源必须由另一个函数释放的函数应标记为
<code>[[nodiscard]]</code>。 一个典型的例子是分配内存的函数，例如<code>malloc()</code>或分配器的成员函数<code>allocate()</code>。
但是请注意，某些函数可能会返回一个值，后续无需再针对这个值做其他调用。 例如，程序员调用大小为零字节的C函数<code>realloc(0</code>以释放内存，这个函数的返回值就不必保存以后再调用<code>free()</code></li>
<li>一个关于不使用返回值那么函数的行为将会改变的例子是<code>std::async</code>（由C++11引入）。它的目的是异步启动任务，并返回一个句柄以等待其结束（并使用结果）。当返回值没使用时，这个调用会成为同步调用，因为未使用的返回值的析构函数会立即调用，即立刻开始等待任务结束。 因此，不使用返回值会与<code>std::async()</code>的设计目的相矛盾。 这种情况下用<code>[[nodiscard]]</code>让编译器对此发出警告。</li>
<li>另一个例子是成员函数<code>empty()</code>，它检查对象是否没有元素。程序员有时候可能错误的调用这个函数来清空容器（译注：即误以为empty做动词）</li>
</ul>
<pre><code class="language-cpp">cont.empty();
</code></pre>
<p>这种对<code>empty()</code>的误用可以被检查出来，因为它的返回值没有被使用。将成员函数标注这个属性即可：</p>
<pre><code class="language-cpp">class MyContainer {
  ...
public:
  [[nodiscard]] bool empty() const noexcept;
  ...
};
</code></pre>
<p>尽管这个是C++17引入的，但是标准库至今都没有使用它。对于C++17来说，应用此功能的建议来得太晚了。因此关于这个特性的关键动机，即为<code>std::async()</code>的声明添加现在都没有完成。对于上述所有示例，下一个C++标准将附带相应的修复程序（具体参见已经接受的提案<a href="https://wg21.link/p0600r1">https://wg21.link/p0600r1</a>）。为了使代码更具可移植性，你应该使用它，而不是使用不可移植的方式（比如gcc或者clang的<code>[[gnu:warn_unused_result]]</code>）来标注函数。当定义<code>operator new()</code>时你应该为函数标记<code>[[nodiscard]]</code>。</p>
<h2 id="72-maybe_unused属性"><a class="header" href="#72-maybe_unused属性">7.2 <code>[[maybe_unused]]</code>属性</a></h2>
<p>新属性<code>[[maybe_unused]]</code>可以用来避免编译器为未被使用的名字或者对象发出警告。</p>
<p>这个属性可以用在类声明上、类型定义<code>typedef</code>或者<code>using</code>上、变量、非静态数据成员、函数、枚举类型或者枚举值。</p>
<p>这个属性的一个应用是标记那些不是必要的参数：</p>
<pre><code class="language-cpp">void foo(int val, [[maybe_unused]] std::string msg)
{
#ifdef DEBUG
  log(msg);
#endif
  ...
}
</code></pre>
<p>另一个例子是标记可能不会使用的成员</p>
<pre><code class="language-cpp">class MyStruct {
  char c;
  int i;
  [[maybe_unused]] char makeLargerSize[100];
  ...
};
</code></pre>
<p>注意，你不能为一个语句标注<code>[[maybe_unused]]</code>。基于这个原因，你不能使用让<code>[[maybe_unused]]</code>与<code>[[nodiscard]]</code>相见：</p>
<pre><code class="language-cpp">int main()
{
  foo(); // WARNING: return value not used
  [[maybe_unused]] foo(); // ERROR: attribute not allowed here
  [[maybe_unused]] auto x = foo(); // OK
}
</code></pre>
<h2 id="73-fallthrough属性"><a class="header" href="#73-fallthrough属性">7.3 <code>[[fallthrough]]</code>属性</a></h2>
<p>新属性<code>[[fallthrough]]</code>可以让编译器不警告那些switch中的某个case没有break，导致其他case被相继执行的情况。</p>
<p>比如：</p>
<pre><code class="language-cpp">void commentPlace(int place)
{
  switch (place) {
    case 1:
      std::cout &lt;&lt; &quot;very &quot;;
      [[fallthrough]];
    case 2:
      std::cout &lt;&lt; &quot;well\n&quot;;
      break;
    default:
      std::cout &lt;&lt; &quot;OK\n&quot;;
      break; 
  } 
}
</code></pre>
<p>传递1会输出</p>
<pre><code>very well
</code></pre>
<p>同时执行了case 1和case 2。</p>
<p>注意这个属性必须被用在空语句中。因此，你需要在它尾巴上加个分号。</p>
<p>在switch的最后一条语句使用这个属性是不允许的。</p>
<h2 id="74-通用属性扩展"><a class="header" href="#74-通用属性扩展">7.4 通用属性扩展</a></h2>
<p>下面的特性在C++17zhong被启用：</p>
<ol>
<li>现在允许为namespace标记属性。比如，你可以像下面代码一样弃用一个命名空间：</li>
</ol>
<pre><code class="language-cpp">namespace [[deprecated]] DraftAPI {
  ...
}
</code></pre>
<p>也可以用于inline namespace和匿名namespace。
2. 枚举值现在也可以标注属性。</p>
<p>比如，你可以引入新的枚举值代替原有的枚举值，然后弃用原有枚举值：</p>
<pre><code class="language-cpp">enum class City { Berlin = 0,
                  NewYork = 1,
                  Mumbai = 2, Bombay [[deprecated]] = Mumbai,
                  ... };
</code></pre>
<p>Mumbai和Bombay都表示相同的city数值，但是Bombay已经弃用。注意标记枚举值时，语法上需要将属性放到枚举值名字的后面。</p>
<ol start="3">
<li>用户定义的属性它们通常在自己的namespace定义，你现在可以使用using来避免重复书写namespace。换句话说，以前写法是：</li>
</ol>
<pre><code class="language-cpp">[[MyLib::WebService, MyLib::RestService, MyLib::doc(&quot;html&quot;)]] void foo();
</code></pre>
<p>现在你可以这么写：</p>
<pre><code class="language-cpp">[[using MyLib: WebService, RestService, doc(&quot;html&quot;)]] void foo();
</code></pre>
<p>注意用了using之后再书写namespace前缀会出错的：</p>
<pre><code class="language-cpp">[[using MyLib: MyLib::doc(&quot;html&quot;)]] void foo(); // ERROR
</code></pre>
<h2 id="75-后记"><a class="header" href="#75-后记">7.5 后记</a></h2>
<p>这三个属性最初由Andrew Tomazos在<a href="https://wg21.link/p0068r0">https://wg21.link/p0068r0</a>中提出。最后<code>[[nodiscard]]</code>的公认措辞是由Andrew Tomazos在<a href="https://wg21.link/p0189r1">https://wg21.link/p0189r1</a>中给出。<code>[[maybe_unused]]</code>的公认措辞是由Andrew Tomazos在<a href="https://wg21.link/p0212r1">https://wg21.link/p0212r1</a>中给出。<code>[[fallthrough]]</code>的公认措辞是由Andrew Tomazos在<a href="https://wg21.link/p0188r1">https://wg21.link/p0188r1</a>中给出。</p>
<p>允许namespace和枚举值标注属性这个特性最初由 Richard Smith在<a href="https://wg21.link/n4196">https://wg21.link/n4196</a>中提出。最后的公认措辞是由 Richard Smith在<a href="https://wg21.link/n4266">https://wg21.link/n4266</a>中给出。</p>
<p>属性允许使用using这个特性最初由J. Daniel Garcia, Luis M. Sanchez, Massimo
Torquati, Marco Danelutto和Peter Sommerlad在<a href="https://wg21.link/p0028r0">https://wg21.link/p0028r0</a>中提出。最后的公认措辞是由J. Daniel Garcia and Daveed Vandevoorde在<a href="https://wg21.link/P0028R4">https://wg21.link/P0028R4</a>中给出。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../part1/cp6.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../part1/cp8.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../part1/cp6.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../part1/cp8.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
